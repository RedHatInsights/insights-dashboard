import React, { Suspense } from 'react';
import VulnerabilityCard from './VulnerabilityCard';
import Loading from '../../PresentationalComponents/Loading/Loading';
import { cvesInterceptors } from '../../../cypress/support/interceptors';
import Masonry from 'react-masonry-css';
import { Grid } from '@patternfly/react-core/dist/esm/layouts';

before(() => {
    cy.mockWindowChrome();
});

const breakpointColumnsObj = {
    default: 2,
    992: 1
};

const MountVulnerabilityCard = () => {
    return (
        <Grid hasGutter>
            <Masonry
                breakpointCols={breakpointColumnsObj}
                className="ins-l-masonry"
                columnClassName="ins-l-masonry_column"
            >
                <Suspense fallback={ <Loading /> }>
                    <VulnerabilityCard />
                </Suspense>;
            </Masonry>
        </Grid>
    );
};

describe('Dashboard CVES', () => {
    beforeEach(() => {
        cvesInterceptors.successful();
        cy.mountWithContext(MountVulnerabilityCard);});
    it('the text in the header text is correct', () => {
        cy.get('div[class="pf-c-content insd-c-width-limiter"]')
        .should('have.text',
            'Red Hat recommends addressing these CVEs with high priority due to heightened risk associated with these security issues. ' +
            'This dataset summary only shows CVEs with Errata.');
    });
    it('the first metrics value is correct ', () => {
        cy.get('div[class="insd-c-dashboard__card--Vulnerabilities--SplitMetrics__content"]').find('a').eq(1).should('have.text', '41');
    });
    it('the second metrics value is correct ', () => {
        cy.get('div[class="insd-c-dashboard__card--Vulnerabilities--SplitMetrics__content"]').find('a').eq(0).should('have.text', '56');
    });

    it('the first toggle is clickable', () => {
        cy.get('button[id="insd-c-dashboard__card-title--Vulnerabilities-toggle-button"]').click();
        cy.get('div[class="insd-c-dashboard__card--Vulnerabilities--SplitMetrics__item"]').should('not.exist');
    });
    it('the second toggle is clickable', () => {
        cy.get('button[id="insd-c-dashboard__card-title--CVESbyCVSS-toggle-button"]').click();
        cy.get('div[class="insd-c-dashboard__card-chart-container"]').should('not.exist');
    });
});

describe('Dashboard CVES Empty state', () => {
    beforeEach(() => {
        cvesInterceptors['successful empty']();
        cy.mountWithContext(MountVulnerabilityCard);});
    it('the text in the header text is correct', () => {
        cy.get('div[class="pf-c-content insd-c-width-limiter"]')
        .should('have.text',
            'Red Hat recommends addressing these CVEs with high priority due to heightened risk associated with these security issues. ' +
            'This dataset summary only shows CVEs with Errata.');
    });
    it('the first metrics value is correct ', () => {
        cy.get('div[class="insd-c-dashboard__card--Vulnerabilities--SplitMetrics__content"]').find('a').eq(0).should('have.text', '0');
    });
    it('the second metrics value is correct ', () => {
        cy.get('div[class="insd-c-dashboard__card--Vulnerabilities--SplitMetrics__content"]').find('a').eq(1).should('have.text', '0');
    });

    it('the first toggle is clickable', () => {
        cy.get('button[id="insd-c-dashboard__card-title--Vulnerabilities-toggle-button"]').click();
        cy.get('div[class="insd-c-dashboard__card--Vulnerabilities--SplitMetrics__item"]').should('not.exist');
    });
    it('the second toggle is clickable', () => {
        cy.get('button[id="insd-c-dashboard__card-title--CVESbyCVSS-toggle-button"]').click();
        cy.get('div[class="insd-c-dashboard__card-chart-container"]').should('not.exist');
    });
});

describe('Dashboard CVEs Error state', () => {
    beforeEach(() => {
        cvesInterceptors['failed with server error']();
        cy.mountWithContext(MountVulnerabilityCard);});

    it('the text in the header text is correct', () => {
        cy.get('div[class="pf-c-empty-state insd-c-dashboard__error-state undefined"]')
        .should('have.text',
            ' Vulnerability has experienced an error. Contact Red Hat support if the problem persists. ');
    });
});
