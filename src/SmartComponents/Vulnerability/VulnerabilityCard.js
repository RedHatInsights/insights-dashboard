import * as AppActions from '../../AppActions';
import { Divider } from '@patternfly/react-core/dist/js/components/Divider/Divider';
import {
    TemplateCard,
    TemplateCardBody,
    TemplateCardHeader,
    TemplateCardHead,
    TemplateCardActions,
    TemplateCardFooter
} from '../../PresentationalComponents/Template/TemplateCard';
import { ExclamationCircleIcon, FlagIcon } from '@patternfly/react-icons';
import React, { Component } from 'react';
import Loading from '../../PresentationalComponents/Loading/Loading';
import PropTypes from 'prop-types';
import { UI_BASE } from '../../AppConstants';
import { connect } from 'react-redux';
import routerParams from '@redhat-cloud-services/frontend-components-utilities/files/RouterParams';
import { NumberDescription } from '../../../../insights-dashboard/src/PresentationalComponents/NumberDescription/NumberDescription';
import { VerticalDivider } from '../../../../insights-dashboard/src/PresentationalComponents/VerticalDivider/VerticalDivider';
import StackChartTemplate from '../../ChartTemplates/StackChart/StackChartTemplate';

/**
 * Vulnerability Card for showing number of critical vulnerabilities
 */
class VulnerabilityCard extends Component {

    constructor(props) {
        super(props);
        this.props = {};
    }

    componentDidMount() {
        this.props.fetchCriticalVulnerabilities();
        this.props.fetchLatestVulnerabilities();
        this.props.fetchVulnerabilities();
    }

    render() {
        const {
            criticalVulnerabilitiesFetchStatus,
            latestVulnerabilitiesFetchStatus,
            criticalVulnerabilities,
            latestVulnerabilities,
            vulnerabilitiesFetchStatus,
            vulnerabilities
        } = this.props;

        const data1 = [{ name: 'Cats', x: '2015', y: 1, label: 'Cats: 1' }];
        const data2 = [{ name: 'Dogs', x: '2015', y: 2, label: 'Dogs: 2' }];
        const data3 = [{ name: 'Cats', x: '2015', y: 3, label: 'Cats: 1' }];
        const stackChartPadding = { bottom: 75, left: 50, right: 50, top: 50 };
        const stackChartLegendData = [
            { name: 'CVSS 8.0 - 10', symbol: { fill: '#06c', type: 'circle' } },
            { name: 'CVSS 4.0 - 7.9', symbol: { fill: '#009596', type: 'circle' } },
            { name: 'CVSS 0.0 - 3.9', symbol: { fill: '#4cb140', type: 'circle' } }
        ];

        return (
            <TemplateCard className='ins-c-card__vulnerability'
                { ...(
                    criticalVulnerabilitiesFetchStatus !== 'pending' &&
                    latestVulnerabilitiesFetchStatus !== 'pending' &&
                    vulnerabilitiesFetchStatus !== 'pending'
                ) ? {
                        'data-ouia-safe': true
                    } : {
                        'data-ouia-safe': false
                    } }
            >
                <TemplateCardHead>
                    <TemplateCardActions
                        downloadReport="true"
                        infoInlineMessage="Learn about CVSS Scores">
                    </TemplateCardActions>
                    <TemplateCardHeader title="Vulnerabilities"/>
                </TemplateCardHead>
                <TemplateCardBody>
                    <StackChartTemplate
                        ariaDesc="CVEs impacting your system"
                        ariaTitle=""
                        domainPadding={ { x: [30, 25] } }
                        legendData={ stackChartLegendData }
                        legendPosition="bottom-left"
                        height={ 100 }
                        padding={ stackChartPadding }
                        colorScale={ ['#06c', '#009596', '#4cb140'] }
                        width={ 450 }
                        data1={ data1 }
                        data2={ data2 }
                        data3={ data3 }
                    />
                    {criticalVulnerabilitiesFetchStatus === 'fulfilled' && (
                        <div className='ins-c-summary'>
                            <ExclamationCircleIcon className='ins-c-summary__icon ins-c-summary__icon-critical' />
                            <span className='ins-c-summary__emphasis'>{criticalVulnerabilities.meta.total_items}</span>
                            <span className='ins-c-summary__label'>
                                <a href={ `${UI_BASE}/vulnerability/cves?cvss_filter=from8to10` }>CVEs with CVSS score &gt;= 8</a>
                            </span>
                        </div>
                    )} {criticalVulnerabilitiesFetchStatus === 'pending' && (<Loading />)}
                    {latestVulnerabilitiesFetchStatus === 'fulfilled' && (
                        <div className='ins-c-summary'>
                            <FlagIcon className='ins-c-summary__icon ins-c-summary__icon-flag' />
                            <span className='ins-c-summary__emphasis'>{latestVulnerabilities.meta.total_items}</span>
                            <span className='ins-c-summary__label'>
                                <a href={ `${UI_BASE}/vulnerability/cves?publish_date=last7&show_irrelevant=true` }>CVEs added in the last 7 days</a>
                            </span>
                        </div>
                    )}
                </TemplateCardBody>
                <Divider/>
                <TemplateCardBody isFilled={ false } isHorizontalLayout="true">
                    <NumberDescription
                        data="NA"
                        dataSize="md"
                        linkDescription="Last 90 days"
                    />
                    <VerticalDivider/>
                    <NumberDescription
                        data="NA"
                        dataSize="md"
                        linkDescription="Last 30 days"
                    />
                    <VerticalDivider/>
                    <NumberDescription
                        data="NA"
                        dataSize="md"
                        linkDescription="Last 7 days"
                    />
                </TemplateCardBody>
                <TemplateCardFooter>
                    <a href={ `${UI_BASE}/vulnerability/` }>
                        View all{vulnerabilitiesFetchStatus === 'fulfilled' && vulnerabilities.meta.total_items > 0 ?
                            ` ${vulnerabilities.meta.total_items} ` : ''} vulnerabilities
                    </a>
                </TemplateCardFooter>
            </TemplateCard>
        );
    }
}

VulnerabilityCard.propTypes = {
    fetchCriticalVulnerabilities: PropTypes.func,
    criticalVulnerabilities: PropTypes.object,
    criticalVulnerabilitiesFetchStatus: PropTypes.string,
    fetchLatestVulnerabilities: PropTypes.func,
    latestVulnerabilities: PropTypes.object,
    latestVulnerabilitiesFetchStatus: PropTypes.string,
    fetchVulnerabilities: PropTypes.func,
    vulnerabilities: PropTypes.object,
    vulnerabilitiesFetchStatus: PropTypes.string
};

const mapStateToProps = (state, ownProps) => ({
    criticalVulnerabilities: state.DashboardStore.criticalVulnerabilities,
    criticalVulnerabilitiesFetchStatus: state.DashboardStore.criticalVulnerabilitiesFetchStatus,
    latestVulnerabilities: state.DashboardStore.latestVulnerabilities,
    latestVulnerabilitiesFetchStatus: state.DashboardStore.latestVulnerabilitiesFetchStatus,
    vulnerabilities: state.DashboardStore.vulnerabilities,
    vulnerabilitiesFetchStatus: state.DashboardStore.vulnerabilitiesFetchStatus,
    ...ownProps
});

const mapDispatchToProps = dispatch => ({
    fetchCriticalVulnerabilities: (url) => dispatch(AppActions.fetchCriticalVulnerabilities(url)),
    fetchLatestVulnerabilities: (url) => dispatch(AppActions.fetchLatestVulnerabilities(url)),
    fetchVulnerabilities: (url) => dispatch(AppActions.fetchVulnerabilities(url))
});

export default routerParams(connect(
    mapStateToProps,
    mapDispatchToProps
)(VulnerabilityCard));
