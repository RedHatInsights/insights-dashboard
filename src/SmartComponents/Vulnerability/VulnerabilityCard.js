import * as AppActions from '../../AppActions';
import { Divider } from '@patternfly/react-core/dist/js/components/Divider/Divider';
import {
    TemplateCard,
    TemplateCardBody,
    TemplateCardHeader,
    TemplateCardHead,
    TemplateCardActions
} from '../../PresentationalComponents/Template/TemplateCard';
import React, { Component } from 'react';
import Loading from '../../PresentationalComponents/Loading/Loading';
import PropTypes from 'prop-types';
import { UI_BASE } from '../../AppConstants';
import { injectIntl } from 'react-intl';
import messages from '../../Messages';
import { connect } from 'react-redux';
import routerParams from '@redhat-cloud-services/frontend-components-utilities/files/RouterParams';
import { NumberDescription } from '../../../../insights-dashboard/src/PresentationalComponents/NumberDescription/NumberDescription';
import { VerticalDivider } from '../../../../insights-dashboard/src/PresentationalComponents/VerticalDivider/VerticalDivider';
import StackChartTemplate from '../../ChartTemplates/StackChart/StackChartTemplate';

/**
 * Vulnerability Card for showing number of critical vulnerabilities
 */
class VulnerabilityCard extends Component {

    constructor(props) {
        super(props);
        this.props = {};
    }

    componentDidMount() {
        this.props.fetchCriticalVulnerabilities();
        this.props.fetchLatestVulnerabilities();
        this.props.fetchVulnerabilities();
    }

    render() {
        const {
            criticalVulnerabilitiesFetchStatus,
            latestVulnerabilitiesFetchStatus,
            criticalVulnerabilities,
            latestVulnerabilities,
            vulnerabilitiesFetchStatus,
            vulnerabilities,
            intl
        } = this.props;

        const chartData = [
            { name: `${criticalVulnerabilitiesFetchStatus === 'fulfilled' && (criticalVulnerabilities.meta.total_items)} CVSS 8.0 - 10`,
                x: '2015',
                y: criticalVulnerabilitiesFetchStatus === 'fulfilled' && (criticalVulnerabilities.meta.total_items), fill: '#a30000'
            },
            { name: 'CVSS 4.0 - 7.9', x: '2015', y: 20, fill: '#ec7a08' },
            { name: 'CVSS 0.0 - 3.9', x: '2015', y: 40, fill: '#f0ab00' }
        ];
        const stackChartLegendData = chartData.map(item => ({ name: `${item.name}`, symbol: { fill: `${item.fill}`, type: 'circle' } }));

        return (
            <TemplateCard className='ins-c-card__vulnerability'
                { ...(
                    criticalVulnerabilitiesFetchStatus !== 'pending' &&
                    latestVulnerabilitiesFetchStatus !== 'pending' &&
                    vulnerabilitiesFetchStatus !== 'pending'
                ) ? {
                        'data-ouia-safe': true
                    } : {
                        'data-ouia-safe': false
                    } }
            >
                <TemplateCardHead>
                    <TemplateCardActions
                        downloadReport="true"
                        infoInlineMessage="Learn about CVSS Scores">
                    </TemplateCardActions>
                    <TemplateCardHeader title="Vulnerabilities"/>
                </TemplateCardHead>
                <TemplateCardBody>
                    { vulnerabilitiesFetchStatus === 'fulfilled' && vulnerabilities.meta.total_items > 0 &&
                        <NumberDescription
                            data={ intl.formatMessage(messages.vulnerabilitiesTotalItems,
                                { total: vulnerabilities.meta.total_items }
                            ) }
                            dataSize="md"
                            linkDescription="CVEs impacting your systems"
                            layout="horizontal"
                            link={ `${UI_BASE}/vulnerability/` }
                        />
                    }
                    <StackChartTemplate
                        ariaDesc="CVEs impacting your systems"
                        ariaTitle="Vulnerabilities chart"
                        height={ 40 }
                        width={ 600 }
                        maxWidth={ 600 }
                        legendHeight={ 36 }
                        legendWidth={ 600 }
                        data={ chartData }
                        legendData={ stackChartLegendData }
                    />
                    {criticalVulnerabilitiesFetchStatus === 'pending' && (<Loading />)}
                </TemplateCardBody>
                <Divider/>
                <TemplateCardBody isFilled={ false } isHorizontalLayout="true">
                    <NumberDescription
                        data="NA"
                        dataSize="md"
                        linkDescription="Last 90 days"
                    />
                    <VerticalDivider/>
                    <NumberDescription
                        data="NA"
                        dataSize="md"
                        linkDescription="Last 30 days"
                    />
                    <VerticalDivider/>
                    { latestVulnerabilitiesFetchStatus === 'fulfilled' && (
                        <NumberDescription
                            data={ intl.formatMessage(messages.latestVulnerabilitiesTotal,
                                { totalLatest: latestVulnerabilities.meta.total_items }
                            ) }
                            dataSize="md"
                            linkDescription="Last 7 days"
                            link={ `${UI_BASE}/vulnerability/cves?publish_date=last7&show_irrelevant=true` }
                        />
                    ) }
                </TemplateCardBody>
            </TemplateCard>
        );
    }
}

VulnerabilityCard.propTypes = {
    fetchCriticalVulnerabilities: PropTypes.func,
    criticalVulnerabilities: PropTypes.object,
    criticalVulnerabilitiesFetchStatus: PropTypes.string,
    fetchLatestVulnerabilities: PropTypes.func,
    latestVulnerabilities: PropTypes.object,
    latestVulnerabilitiesFetchStatus: PropTypes.string,
    fetchVulnerabilities: PropTypes.func,
    vulnerabilities: PropTypes.object,
    vulnerabilitiesFetchStatus: PropTypes.string,
    intl: PropTypes.any
};

const mapStateToProps = (state, ownProps) => ({
    criticalVulnerabilities: state.DashboardStore.criticalVulnerabilities,
    criticalVulnerabilitiesFetchStatus: state.DashboardStore.criticalVulnerabilitiesFetchStatus,
    latestVulnerabilities: state.DashboardStore.latestVulnerabilities,
    latestVulnerabilitiesFetchStatus: state.DashboardStore.latestVulnerabilitiesFetchStatus,
    vulnerabilities: state.DashboardStore.vulnerabilities,
    vulnerabilitiesFetchStatus: state.DashboardStore.vulnerabilitiesFetchStatus,
    ...ownProps
});

const mapDispatchToProps = dispatch => ({
    fetchCriticalVulnerabilities: (url) => dispatch(AppActions.fetchCriticalVulnerabilities(url)),
    fetchLatestVulnerabilities: (url) => dispatch(AppActions.fetchLatestVulnerabilities(url)),
    fetchVulnerabilities: (url) => dispatch(AppActions.fetchVulnerabilities(url))
});

export default injectIntl(routerParams(connect(
    mapStateToProps,
    mapDispatchToProps
)(VulnerabilityCard)));
